from PIL import Image
import numpy as np
import os

def scan_image_for_exe(image_path):
    """
    Quét ảnh tìm dấu hiệu chứa EXE
    """
    print(f"[*] Scanning: {image_path}")
    
    results = {
        'suspicious': False,
        'reasons': []
    }
    
    # 1. Kiểm tra file size bất thường
    file_size = os.path.getsize(image_path)
    img = Image.open(image_path)
    expected_size = img.size[0] * img.size[1] * 3  # RGB
    
    if file_size > expected_size * 1.5:
        results['suspicious'] = True
        results['reasons'].append(f"⚠️  File size quá lớn ({file_size:,} bytes)")
    
    # 2. Kiểm tra PNG với JPEG extension
    if image_path.lower().endswith('.jpg') and img.format == 'PNG':
        results['suspicious'] = True
        results['reasons'].append("⚠️  Extension không khớp format")
    
    # 3. Entropy analysis
    img_array = np.array(img)
    lsb = img_array & 1
    
    from scipy.stats import entropy
    from collections import Counter
    
    lsb_flat = lsb.flatten()
    counts = Counter(lsb_flat)
    ent = entropy(list(counts.values()))
    
    if ent > 0.95:  # Entropy cao bất thường
        results['suspicious'] = True
        results['reasons'].append(f"⚠️  Entropy cao: {ent:.4f}")
    
    # 4. Scan for EXE signatures
    with open(image_path, 'rb') as f:
        data = f.read()
    
    exe_signatures = [
        b'MZ',  # Windows PE
        b'\x7fELF',  # Linux ELF
        b'<<EXE_START>>',  # Custom marker
    ]
    
    for sig in exe_signatures:
        if sig in data:
            results['suspicious'] = True
            results['reasons'].append(f"⚠️  Phát hiện signature: {sig}")
    
    # Print results
    if results['suspicious']:
        print("[!] ❌ SUSPICIOUS IMAGE DETECTED!")
        for reason in results['reasons']:
            print(f"    {reason}")
    else:
        print("[+] ✅ Image appears clean")
    
    return results

# Scan
scan_image_for_exe('normal.png')